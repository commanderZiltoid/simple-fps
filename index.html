<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <link rel="stylesheet" href="/css/custom.css" media="all"/>
    </head>
    <body>
        <div id="blocker">
            <div id="instructions">
                <span style="font-size:40px">Basic WASD/Mouse Movement</span>
                <br/>
                <span style="font-size:30px">Click to start</span>
                <br />
                (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
            </div>
        </div>




        <script src="/libs/three.js"></script>
        <script src="/libs/PointerLockControls.js"></script>
        
        
        <script src="/src/verify_pointerlock.js"></script>
        <script src="/src/TextureAnimator.js"></script>
<script>
// =============================================================================
//  The Client.
// =============================================================================
var Client = function(){
  
    this.id = null;
    
    this.key_left = false;
    this.key_right = false;
    this.key_up = false;
    this.key_down = false;
    this.jump = false;
    
    this.peers = new Object;
    
        
};

Client.prototype.processInputs = function(){
    if (controlsEnabled) {

        var time = performance.now();
        var delta = ( time - prevTime ) / 1000;

        velocity.x -= velocity.x * 10.0 * delta;
        velocity.z -= velocity.z * 10.0 * delta;
        velocity.y -= 9.8 * 100.0 * delta; // 100.0 = mass

        if ( this.key_up ) velocity.z -= 400.0 * delta;
        if ( this.key_down ) velocity.z += 400.0 * delta;
        if ( this.key_left ) velocity.x -= 400.0 * delta;
        if ( this.key_right ) velocity.x += 400.0 * delta;

        controls.getObject().translateX( velocity.x * delta );
        controls.getObject().translateY( velocity.y * delta );
        controls.getObject().translateZ( velocity.z * delta );

        if ( controls.getObject().position.y < 10 ) {
                velocity.y = 0;
                controls.getObject().position.y = 10;
                this.jump = true;
        }

        prevTime = time;

    }
};

// Find the position each player is facing relative to
// the current player camera position and display the 
// correct texture on the player billboard, animate texture
Client.prototype.animatePeers = function(){
    
    var animation_speed = 1000 * clock.getDelta();
    
    for(var peer_id in this.peers){
        
        var peer = this.peers[peer_id];
        
        var a = new THREE.Vector3();
        a.subVectors(controls.getObject().position, peer.mesh.position);
        a.normalize();

        var b = new THREE.Vector3(0,0,1);
        b.applyQuaternion(peer.mesh.quaternion);
        b.normalize();

        var theta = Math.acos(a.dot(b)) * (180/Math.PI);
        if(a.x * a.z < 0){
            theta = 360.0 - theta;
        }

        if((theta > 0 && theta <= 22.5) || (theta > 337.5 && theta <= 359.99)){//south
            peer.billboard.material.map = peer.textures.s;
            peer.billboard.needsUpdate = true;
            peer.animations.s.update(animation_speed);
        }
        else if(theta > 292.5 && theta <= 337.5){//south east
            peer.billboard.material.map = peer.textures.se;
            peer.billboard.needsUpdate = true;
            peer.animations.se.update(animation_speed);
        }
        else if((theta < 292.5 && theta >= 270) || (theta > 90 && theta <= 112.5)){//east
            peer.billboard.material.map = peer.textures.e;
            peer.billboard.needsUpdate = true;
            peer.animations.e.update(animation_speed);
        }
        else if(theta > 112.5 && theta <= 157.5){//northeast
            peer.billboard.material.map = peer.textures.ne;
            peer.billboard.needsUpdate = true;
            peer.animations.ne.update(animation_speed);
        }
        else if(theta > 157.5 && theta <= 202.5){//north
            peer.billboard.material.map = peer.textures.n;
            peer.billboard.needsUpdate = true;
            peer.animations.n.update(animation_speed);
        }
        else if(theta > 202.5 && theta <= 247.5){//northwest
            peer.billboard.material.map = peer.textures.nw;
            peer.billboard.needsUpdate = true;
            peer.animations.nw.update(animation_speed);
        }
        else if((theta > 67.5 && theta <= 89.99) || (theta > 247.5 && theta <= 269.99)){//west
            peer.billboard.material.map = peer.textures.w;
            peer.billboard.needsUpdate = true;
            peer.animations.w.update(animation_speed);
        }
        else if(theta > 22.5 && theta <= 67.5){//southwest
            peer.billboard.material.map = peer.textures.sw;
            peer.billboard.needsUpdate = true;
            peer.animations.sw.update(animation_speed);
        }

        peer.billboard.lookAt(controls.getObject().position);

    }
};

Client.prototype.addPeer = function(sent_peer){
    var x = -100, y = 10, z = 0;
    this.peers[sent_peer.id] = sent_peer;
    var peer = this.peers[sent_peer.id];

    peer.textures = {
        s:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/s.png'),
        se:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/se.png'),
        e:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/e.png'),
        ne:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/ne.png'),
        n:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/n.png'),
        nw:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/nw.png'),
        w:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/w.png'),
        sw:new THREE.ImageUtils.loadTexture('/assets/textures/player_0/sw.png')
    };

    peer.animations = {
        s:new TextureAnimator(peer.textures.s, 4, 1, 4, 160),
        se:new TextureAnimator(peer.textures.se, 4, 1, 4, 160),
        e:new TextureAnimator(peer.textures.e, 4, 1, 4, 160),
        ne:new TextureAnimator(peer.textures.ne, 4, 1, 4, 160),
        n:new TextureAnimator(peer.textures.n, 4, 1, 4, 160),
        nw:new TextureAnimator(peer.textures.nw, 4, 1, 4, 160),
        w:new TextureAnimator(peer.textures.w, 4, 1, 4, 160),
        sw:new TextureAnimator(peer.textures.sw, 4, 1, 4, 160)
    };

    peer.billboard_mat = new THREE.MeshBasicMaterial({map: peer.textures.n,  transparent:true});
    peer.billboard_geom = new THREE.PlaneGeometry(14, 14, 1, 1);
    peer.billboard = new THREE.Mesh(peer.billboard_geom, peer.billboard_mat);

    peer.material = new THREE.MeshBasicMaterial({transparent:true, opacity:0.0});
    peer.geometry = new THREE.PlaneGeometry(14, 14, 1, 1);
    peer.mesh = new THREE.Mesh(peer.geometry, peer.material);

    peer.billboard.position.set(x,y,z);
    scene.add(peer.billboard);

    peer.mesh.position.set(x,y,z);
    scene.add(peer.mesh);
    
};

Client.prototype.update = function(){

    this.animatePeers();
    this.processInputs();

};

Client.prototype.render = function(){
    
    renderer.render(scene, camera);
    
};

</script>
        <script>
                var camera, 
                    scene, 
                    renderer,
                    geometry,
                    material,
                    mesh,
                    controls,
                    blocker = document.getElementById( 'blocker' ),
                    instructions = document.getElementById( 'instructions' ),
                    controlsEnabled = false,
                    prevTime = performance.now(),
                    velocity = new THREE.Vector3(),
                    clock = new THREE.Clock();



                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);

                scene = new THREE.Scene();
                scene.fog = new THREE.Fog(0xffffff, 0, 750);

                var light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
                light.position.set(0.5, 1, 0.75);
                scene.add(light);

                controls = new THREE.PointerLockControls(camera);
                scene.add(controls.getObject());


                //FLOOR
                geometry = new THREE.PlaneGeometry( 2000, 2000, 100, 100 );
                geometry.rotateX( - Math.PI / 2 );
                for (var i = 0, l = geometry.vertices.length; i < l; i ++) {
                        var vertex = geometry.vertices[ i ];
                        vertex.x += Math.random() * 20 - 10;
                        vertex.y += Math.random() * 2;
                        vertex.z += Math.random() * 20 - 10;
                }
                for (var i = 0, l = geometry.faces.length; i < l; i ++) {
                        var face = geometry.faces[ i ];
                        face.vertexColors[ 0 ] = new THREE.Color().setHSL( Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
                        face.vertexColors[ 1 ] = new THREE.Color().setHSL( Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
                        face.vertexColors[ 2 ] = new THREE.Color().setHSL( Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
                }
                material = new THREE.MeshBasicMaterial({vertexColors: THREE.VertexColors});
                mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);
                //END FLOOR

                // Create renderer
                renderer = new THREE.WebGLRenderer();
                renderer.setClearColor(0xffffff);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);
                

                

                var client = new Client();
                client.addPeer({id:'test_id'});
                
                mainLoop();
                function mainLoop(){
                    
                    requestAnimationFrame(mainLoop);
                    client.update();
                    client.render();
                    
                };                
                
                
        </script>
        

<script src="/src/key_controls.js"></script>
<script src="/src/window_resize.js"></script>
        
</body>
</html>